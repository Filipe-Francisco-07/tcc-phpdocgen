name: docs
on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          coverage: none

      - name: Install Composer deps
        run: composer install --no-interaction --prefer-dist --no-progress

      # opcional: fuma√ßa do seu gerador de DocBlocks
      - name: Run DocGen (smoke)
        env:
          DOCGEN_FAKE: "1"
          OPENAI_API_KEY: "test"
        run: php bin/run.php --base ci || true

      - name: Download phpDocumentor PHAR
        run: curl -fsSL https://phpdoc.org/phpDocumentor.phar -o phpdoc.phar

      - name: Generate docs
        run: php phpdoc.phar -c phpdoc.xml

      - name: Upload artifact (docs)
        uses: actions/upload-pages-artifact@v3
        with:
          path: docs

  deploy:
    if: github.ref == 'refs/heads/main'
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/deploy-pages@v4
